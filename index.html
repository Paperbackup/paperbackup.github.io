<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>optar</title>
<style>
  body{font-family:system-ui, sans-serif; margin:2rem}
  button{margin-top:1rem}
  #log{white-space:pre-wrap; font-size:.8rem; background:#f6f6f6; padding:.5rem; max-height:12rem; overflow:auto}
</style>
</head>
<body>

<h1>OPTAR (OPTical ARchiver)</h1>
<p style="color:#bbb">*WebAssembly used, no server side processing. Files are not uploaded to any servers, preserving your privacy.</p>
<p>Backup any file with printable paper copies. Originally made by <a href=https://ronja.twibright.com/optar/ target=_blank>Twibright Labs</a>.</p>
<p>Use <a href=unoptar.html>unoptar</a> to decode scanned optar PNGs (only supports 32x46 x/ycrosses values at the moment which encodes ~50KB per A4 page)</p>
<form>
<input type="file" id="optarFileInput">
<button id="runBtn" disabled>Run optar</button>
<nbsp>
<span>xcrosses: <input type="number" id="xcrosses" value=32 placeholder="32" style="width: 3em">
ycrosses: <input type="number" id="ycrosses" value=46 placeholder="46" style="width: 3em"></span> <abbr title="a bigger x y value will increase the amount of data encoded on a page (e.g. 65 93 will encode 200KB per A4 page), but will need more powerful printers and scanners (1200+dpi). The default 32 46 encodes 50KB per page.">
 <span>&#xFE56;<span/></abbr>
<input type="reset"/>
</span>

<div id="log"></div>


<!-- 1. Emscripten glue for optar -->
<script src="./wasm/optar.js"></script>

<!-- 2. MagickWasm (browser ImageMagick) -->
<!-- <script type='module' src="https://unpkg.com/wasm-imagemagick@1.2.8/dist/bundles/magickApi.js"></script> -->

<script>
const log = (...args) => {
  const box = document.getElementById('log');
  box.textContent += args.join(' ') + '\n';
  box.scrollTop = box.scrollHeight;
};
const downloadBlob = (blob, name) => {
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = name;
  a.click();
  URL.revokeObjectURL(a.href);
};


const fileInput = document.getElementById('optarFileInput');
const runBtn    = document.getElementById('runBtn');
const xInput = document.getElementById('xcrosses');
const yInput = document.getElementById('ycrosses');
runBtn.disabled = !fileInput.files.length;

fileInput.addEventListener('change', () => {
  runBtn.disabled = !fileInput.files.length;
});


runBtn.addEventListener('click', async () => {
  runBtn.disabled = true;
  log('Starting... (please refresh the page before encoding another file)');

  const file = fileInput.files[0];
  if (!file) {
    log("no file input..");
  }
  const FS = this.FS;
  const node = file.name.replace(/[^a-z0-9_.-]/gi, '_');
  const buf = await file.arrayBuffer();

  var reader = new FileReader();
  reader.onload = async function() {
    var fileString = new TextDecoder('utf-8').decode(this.result);
    // console.log('file content:', fileString);

    FS.writeFile('/' + node, fileString);
    log('wrote', node, 'to MEMFS');

    var xval = "32";
    var yval = "46";
    if ((xInput.value != "") && (yInput.value != "")) {
      xval = xInput.value;
      yval = yInput.value;
    }
    run(['/'+node, node, xval, yval]);
    log('optar finished');

    const files = FS.readdir('/').filter(n => n.endsWith('.pgm'));
    if (!files.length) { log('No .pgm files produced'); return; }

    /* ---------- 3. ImageMagick conversions ---------- */
    for (const pgmName of files) {
      const pgmData   = FS.readFile('/' + pgmName);
      const pgmBlob   = new Blob([pgmData], {type:'image/x-portable-graymap'});
      console.log(`${pgmName}:`,pgmData);
      downloadBlob(pgmBlob, pgmName);
    }
    log('Done.');
    runBtn.disabled = false;

    return; 
  }
  reader.readAsArrayBuffer(file);
});

</script>
</body>
</html>
